"use client"

import { useEffect, useState } from "react"

export function ClientVis() {

  const input = sample2
  const map = getInputMap(input)
  const [cache, setCache] = useState(new Map())

  function getCount(map: string[][], y: number, x: number, dir: "left" | "right" | "up" | "down") {
    const visited = new Map<`${number} ${number}`, true>()
    const traverse = (y: number, x: number, dir: "left" | "right" | "up" | "down") => {
      if (y < 0 || y >= map.length || x < 0 || x >= map[0].length) return 0
      console.log(y, x, dir)
      // console.log(cache)
      const cacheitem = cache.get(`${y} ${x} ${dir}`)
      if (cacheitem !== undefined) {
        if (!visited.has(`${y} ${x}`)) {
          // console.log("Cache Hit & unvisited!", cacheitem)
          return cacheitem
        }
        else {
          // console.log("previous path visited!")
          return 0
        }
      }


      let count = 0
      setCache(new Map(cache.set(`${y} ${x} ${dir}`, count)))

      const curr = map[y][x]
      if ((curr === '.' && dir === "right") || (curr === '-' && (dir === "down" || dir === "up" || dir === "right")) || (curr === '/' && dir === "up") || (curr === '\\' && dir === "down")) {
        count += traverse(y, x + 1, "right")
      }
      if ((curr === '.' && dir === "left") || (curr === '-' && (dir === "down" || dir === "up" || dir === "left")) || (curr === '/' && dir === 'down') || (curr === '\\' && dir === "up")) {
        count += traverse(y, x - 1, "left")
      }
      if ((curr === '.' && dir === "up") || (curr === '|' && (dir === "left" || dir === "right" || dir === "up")) || (curr === '/' && dir === 'right') || (curr === '\\' && dir === "left")) {
        count += traverse(y - 1, x, "up")
      }
      if ((curr === '.' && dir === "down") || (curr === '|' && (dir === "left" || dir === "right" || dir === "down")) || (curr === '/' && dir === 'left') || (curr === '\\' && dir === "right")) {
        count += traverse(y + 1, x, "down")
      }
      if (!visited.has(`${y} ${x}`)) {
        visited.set(`${y} ${x}`, true)
        count++
      }
      // console.log("pos", [y, x], "ways", count)
      setCache(new Map(cache.set(`${y} ${x} ${dir}`, count)))
      return count
    }
    return traverse(y, x, dir)
  }

  // const [render, setRender] = useState(false)

  useEffect(() => {
    getCount(map, 0, 0, "right")
  },[])

  // useEffect(() => {
  //   const interval = setInterval(() => {
  //     if(render) setRender(!render)
  //   },5)
  //   return () => {
  //     clearInterval(interval)
  //   }
  // },[])

  return <div style={ {
    backgroundColor: '#222',
    // padding: '1rem',
    margin: '1rem',
    display: 'flex',
    borderRadius: '4px',
    flexDirection: 'column'
  } }>
    {
      input.split('\n').map((row, i) => {
        return <div key={ i } style={ {
          display: "flex",
          flexDirection: 'row'
        } }>
          {
            row.split('').map((tile, i) => {
              return <Tile key={ i } char={ tile } state={[false, true, false, false]} />
            })
          }
        </div>
      })
    }
  </div>
}

function getInputMap(input: string) {
  return input.split('\n').map(row => row.split(''))
}


function Tile(p: {
  char: string,
  //       left     right    up       down  
  state?: [boolean, boolean, boolean, boolean]
}) {
  return <div style={ {
    width: 16,
    height: 16,
    position: 'relative'
  } }>
    {
      p.char === "|" && <>
        { p.state?.[0] && <>
          <Beam dir="left" halves={ [true, false] } />
        </> }
        { p.state?.[1] && <>
          <Beam dir="right" halves={ [true, false] } />
        </> }

        <Line rotate={ 0 } />
      </>
    }
    {
      p.char === "-" && <>
        { p.state?.[2] && <>
          <Beam dir="up" halves={ [true, false] } />
        </> }
        <Line rotate={ 90 } />
      </>
    }
    {
      p.char === "/" && <>
        { p.state?.[0] && <>
          <Beam dir="left" halves={ [true, false] } />
          <Beam dir="down" halves={ [false, true] } />
        </> }
        { p.state?.[1] && <>
          <Beam dir="right" halves={ [true, false] } />
          <Beam dir="up" halves={ [false, true] } />
        </> }
        <Line rotate={ 45 } />
      </>
    }
    {
      p.char === "\\" && <>
        { p.state?.[0] && <>
          <Beam dir="left" halves={ [true, false] } />
          <Beam dir="up" halves={ [false, true] } />
        </> }
        { p.state?.[1] && <>
          <Beam dir="right" halves={ [true, false] } />
          <Beam dir="down" halves={ [false, true] } />
        </> }
        <Line rotate={ 135 } />
      </>
    }
    {
      p.char === "." && <>
        { p.state?.[0] && <>
          <Beam dir="left" halves={ [true, true] } />
        </> }
        { p.state?.[1] && <>
          <Beam dir="right" halves={ [true, true] } />
        </> }
      </>
    }
    {/* <Beam dir="right" halves={[true, false]} />
    <Beam dir="right" halves={[false, true]} /> */}
    {/* <Beam dir="down" halves={[true, false]} />
    <Beam dir="down" halves={[false, true]} /> */}
    {/* <Beam dir="left" halves={[true, false]} />
    <Beam dir="left" halves={[false, true]} /> */}
    {/* <Beam dir="up" halves={[true, false]} />
    <Beam dir="up" halves={[false, true]} /> */}

  </div>
}

function Line(p: {
  rotate: number
}) {
  return <div style={ {
    position: 'absolute',
    width: 2,
    height: '100%',
    top: 0,
    left: "50%", translate: '-50% 0',
    transformOrigin: 'center',
    background: 'white',
    rotate: `${p.rotate}deg`,
    zIndex: 5
  } } />
}
function Beam(p: {
  dir: "left" | "right" | "up" | "down"
  halves: [boolean, boolean]
}) {
  if (p.dir === "right") return <div style={ {
    position: 'absolute',
    height: 1,
    width: (p.halves[0] && p.halves[1]) ? '100%' : '50%',
    top: '50%', translate: '0 -50%',
    left: (p.halves[0] && !p.halves[1]) ? 0 : (!p.halves[0] && p.halves[1]) ? '50%' : 0,
    background: 'red',
    boxShadow: '0 0 5px red'
  } } />
  if (p.dir === "down") return <div style={ {
    position: 'absolute',
    height: 1,
    width: (p.halves[0] && p.halves[1]) ? '100%' : '50%',
    transformOrigin: (p.halves[0] && !p.halves[1]) ? 'right' : (!p.halves[0] && p.halves[1]) ? 'left' : 'center',
    top: '50%', translate: '0 -50%',
    left: (p.halves[0] && !p.halves[1]) ? 0 : (!p.halves[0] && p.halves[1]) ? '50%' : 0,
    background: 'red',
    boxShadow: '0 0 5px red',
    rotate: '90deg'
  } } />
  if (p.dir === "left") return <div style={ {
    position: 'absolute',
    height: 1,
    width: (p.halves[0] && p.halves[1]) ? '100%' : '50%',
    transformOrigin: (p.halves[0] && !p.halves[1]) ? 'right' : (!p.halves[0] && p.halves[1]) ? 'left' : 'center',
    top: '50%', translate: '0 -50%',
    left: (p.halves[0] && !p.halves[1]) ? 0 : (!p.halves[0] && p.halves[1]) ? '50%' : 0,
    background: 'red',
    boxShadow: '0 0 5px red',
    rotate: '180deg'
  } } />
  if (p.dir === "up") return <div style={ {
    position: 'absolute',
    height: 1,
    width: (p.halves[0] && p.halves[1]) ? '100%' : '50%',
    transformOrigin: (p.halves[0] && !p.halves[1]) ? 'right' : (!p.halves[0] && p.halves[1]) ? 'left' : 'center',
    top: '50%', translate: '0 -50%',
    left: (p.halves[0] && !p.halves[1]) ? 0 : (!p.halves[0] && p.halves[1]) ? '50%' : 0,
    background: 'red',
    boxShadow: '0 0 5px red',
    rotate: '270deg'
  } } />
}


const sample2 = `.|...\\....
|.-.\\.....
.....|-...
........|.
..........
.........\\
..../.\\\\..
.-.-/..|..
.|....-|.\\
..//.|....`

const puzzle = `\\.......\\...-.....|....\\....-...../......\\\\.........../..............\\.....\\-../....................\\.........
.|\\......................./.|.\\./.|.........-.......\\........../.........-........-......................./...
../........\\.......|.\\...../......-......../.....\\............................./................./............
.\\.............................\\.../........\\.................\\....................................-..........
...............\\......|.......-....................|.......|............/-....-................-.............\\
.....\\|........|....\\.................-../........\\./...../.|.....-......................../.............|....
......-...../...|............|..-...............-...........|....\\...................\\...............\\........
./......./....|..........-.|.....|....\\-...............\\......./..............\\..|.............|..............
....|\\.......|-....../......\\........................................\\|......-.................|......|.-..||-
.-.|.......................................\\....-./\\.-....-.../......|................|.\\......./.........-...
.|.../..............|\\..................-.....................\\..\\/|......./..............\\...||.|...../..|.|.
....\\........./.....\\................--...........\\........../......\\.........................-..-........\\...
-.\\./.........\\...\\........./.......-......-...../..-....-..|....././......-........-.-......-.........../....
.....\\.............\\............|.\\|.........................-/......./...|......|.....\\.../.-./..............
.........-.........\\..../.|..................\\../........\\-............/.-../...\\.............-.|.....|.......
......./.|..................../..........-............/....-...................|.............-..........././.-
...-....\\...............\\...............................|....-.......-.....\\.../..|...........\\.......-/....|.
........|.....|..../...................|.....\\.-..-....-....../..-......\\......................|..............
.......|-.-...-\\.......|....|..........|..|..................|..................................|...\\../......
....-|/.../...-..|......-...........\\..........-.....||.............../..........\\..................|...\\.....
..................//...../..........................-..........|...........-.\\........./......................
-..-.................\\-.........\\.................../...........\\../............/...|..............-......|...
..|.|.........|..................../..../-........./.../..........\\./...........|.............................
.......|.....\\./.....|.-....|.........\\.........|......-........./...-...............|.../................./..
|..............................\\................/.|......................./.\\...............\\........\\........
....\\../..........|....../.....|...\\.........|-........|....................../............|/.............|...
..\\......-........................................\\.....|.........-/..\\........................../....|.......
.....\\-../.....\\-/....-..........-.....-.....|.......\\.......\\....../.../...../....\\\\.........................
.........../..........-....../......./........-.............\\...............\\.........-..../...-............-.
........|.....................\\..................................-.\\.\\/.|...../..-..-...\\.-.../...............
/...\\..........-.....|...................\\........./...............-.....|...|......................\\.........
................./........\\.|..............................|.........../..............\\-.........|............
...\\.......\\.../...-.../...../|-...|.../.\\.\\............................|....\\.....-.\\...../.....\\....-...\\...
....-....|............/...|...........-.......|.....-....../........................|......|......\\....\\......
-.........../\\.........|..........|.....\\.............-...../........|............../...|................/-.|/
....................../........\\................................|.....\\..\\..........\\..................|......
..|..............|......../...\\......../-.....-........\\...................................-.............|....
.......//....\\.........|../...\\.......-...-|........\\...|..........\\........................-...\\./....\\......
...-....................|..............\\......|......../-...................\\.|........\\.......-...........\\..
........./..................../\\|./..\\.......................|./..............................................
.........../..............\\.....................|.......\\..............-......-...............................
..........|../................../............................./.../...........\\......-.......-.........-..../-
-..........\\............|..|.............\\................................\\......\\..-...-..........|/....\\..-.
...-...\\../............/..|......-.............\\./.............../...............\\..............-..........|.-
...........|................-..-\\..........\\|/....-.\\.........../.........-.-......................|..........
\\.\\.................\\..../..........-/..............\\.........\\.-....\\......|........................../../...
..................................-.....|-........|......\\...........|..........|.........../.....-..../....-/
...........-.|..........-..........................|\\.\\.....|....\\....-.......................................
......|.............-.........................../............/../......................|.........-...-........
......../...-\\....\\../.......-........|.|......|.......................\\.............../......................
...-................\\....\\........../..........-\\..........................\\..-....-..........................
\\........\\.............\\.......-..-............../......./........-........|...........././............-......
............./................|.\\..........-.....\\-....\\.........\\.............\\....../.....\\.................
.................../......../................|......\\.|...........|.............-./.....|.........../.........
...\\/..........\\\\..............-\\...\\.....\\.....-.............|..........\\.......-/........|................-.
....................-...|.......-....-........-..-..................................../................\\....-.
.-//................/.....\\........\\............|............./..................../...................|......
................../.|............\\..-/....-.............-....................../......|..\\....../.............
/..\\..../.......\\-........././.-....\\..............\\.............-............................-..|............
........\\\\........./.\\.........../..|....\\..........\\.........\\....../...................\\.../-...............
..................................../.........\\.../.....|.-....../..../.....|......|.|........../.....\\|...\\..
|..|...................\\......\\.|..............|./.........|.|........-...|...................|...............
-.........|....\\........|......................./................\\........................\\...................
............/................-|-.....|.-..-.................-..........................-............|.........
.....................................\\\\................|\\...\\...-....................\\........................
.......-..-................/...................|...../..|................................\\......./............
.............../..................................|.-...............\\.../....../.......................-......
................../.......-...................................-...........\\....././...|...........\\..../...-..
......\\........\\..-.......|.....-...\\....................\\|................/-...............-.............|.|.
......//.-\\.-..|...................|.............|....../..........\\.................\\\\...................-...
.........|......./.|..--.......\\.........|..\\................|....\\...........................................
......................./|..............|.........................\\......................\\.....................
...-.............\\../........|..............\\........|.-..................-......................\\............
........\\..../......./............-/......|./|..........-...................../........|.-\\............../.\\..
.|............................................-../...................\\........../..-..|...|..|................
..........................|..................|....\\./.....|...-....-................\\..|..\\..............\\./..
...........................................|.................|.....\\...................|........-......|.-....
.....\\...........|...\\...|..........|........./.........\\./...............-............................-......
...|...........\\...................\\.................-/.........../.......|..../...../..............|.|.......
.|.......|...........\\-........\\....\\......././\\......\\.........-.......\\................\\....-...............
../..........................\\...........---|....../............-.....................|.......||./..../.......
..../...././...|\\................../..........-..../\\............//.......\\....\\.....-.|.................\\...-
..............|.............|............\\.............|....././....../...../..........|../...................
.|...|...........-..//...............................\\................../|....../................../..|.......
........\\...\\......../......../..../..\\....-\\.....-/.................................................|...\\.../
...-.../........|./........\\........./.....-......................-..-................/......|........\\......|
....|..................................|....-.\\.........\\......-................./..............|.............
...-\\.././.\\.|...........-..-.........-...............|..-...-....../|.........-......\\..../..................
..................../......../......../........................||...\\/...../................/......./...//-...
....-.....................\\........-\\...\\...........|........../.....|.........../......\\.....................
..............-.|..../........................\\|..............\\...........//....\\....-....\\...........-.......
..........................|...|.....\\.......................-..........|...|..........-............-...../....
.-..../......./|............|.|........../../..\\...../....-../\\../|.....\\.............|\\............|.........
........\\......./............-..|....|..........|.\\.\\\\..............-............\\........./.................\\
.../................-........-.-........\\........./.\\.|...........|............................/......-.......
.....\\....|-..|......\\...\\.................\\..-..........|--\\............/..../..\\...................-........
\\............\\...........|..............................\\.|........|.....-.........................\\..........
.............|..-|...................|......\\...\\-...........|....\\....|............././......|\\...........\\..
...-....................|...........-........../.......-................./......\\.........|.....\\.-.........-.
........../......\\.\\.........|-./.............................|.\\......\\../..............|...............//...
..|............/..................\\..................................|.\\.|......................../../..\\....\\
....-.-....\\\\/.......\\..........|.-......../................\\....................-.............-...../........
.\\.....|.|................\\...../...................|..............................\\.....|............|..|\\...
.-..........|.....\\-....................\\.......\\...................-|/.|........-........\\.././..|...........
.....-/.....|.........../........................-..|...........\\............|......\\..................../....
../.......-.-/.|..................../....................\\.......|.........\\........../..\\....................
.....-........-...........................\\.............\\................../...\\.......|\\...\\.|...............
.........-.....\\|.-.........|......\\....\\..........................-.|..\\........|......././....../......|....
.....................-................../...-...-...................\\./......./...-.-....-......./...\\..-.....
.\\.--./....................-................\\...............-..\\............-.../...............././.....\\....`

